<!DOCTYPE html><html lang="en-US" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>8. Sharding, Facebook and Implementation | Yuchen You</title><meta name="author" content="Yuchen You (Wesley)"><meta name="copyright" content="Yuchen You (Wesley)"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="分片 (Sharding) 分片是分布式系统设计中的一个关键概念, 它与复制(Replication)一起, 构成了构建大规模系统的基础; 分片的本质与目标 分片的本质在于解决单一机器的限制和不可靠性问题,;  复制(Replication): 通过复制数据来使机器可靠(reliable), 提高容错性; 分片(Sharding): 通过分割数据来提高机器的容量限制 (raise the mach">
<meta property="og:type" content="article">
<meta property="og:title" content="8. Sharding, Facebook and Implementation">
<meta property="og:url" content="http://example.com/2025/12/13/wesley_knowledge_repo/ds/8.sharding/index.html">
<meta property="og:site_name" content="Yuchen You">
<meta property="og:description" content="分片 (Sharding) 分片是分布式系统设计中的一个关键概念, 它与复制(Replication)一起, 构成了构建大规模系统的基础; 分片的本质与目标 分片的本质在于解决单一机器的限制和不可靠性问题,;  复制(Replication): 通过复制数据来使机器可靠(reliable), 提高容错性; 分片(Sharding): 通过分割数据来提高机器的容量限制 (raise the mach">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/me_new.jpeg">
<meta property="article:published_time" content="2025-12-13T12:25:03.000Z">
<meta property="article:modified_time" content="2025-12-14T21:33:26.881Z">
<meta property="article:author" content="Yuchen You (Wesley)">
<meta property="article:tag" content="distributed_sys">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/me_new.jpeg"><link rel="shortcut icon" href="/img/hackerrank.svg"><link rel="canonical" href="http://example.com/2025/12/13/wesley_knowledge_repo/ds/8.sharding/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '8. Sharding, Facebook and Implementation',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-12-15 05:33:26'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/me_new.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">302</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/math_master.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Yuchen You"><img class="site-icon" src="/img/avatar.png"/><span class="site-name">Yuchen You</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">8. Sharding, Facebook and Implementation</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-12-13T12:25:03.000Z" title="Created 2025-12-13 20:25:03">2025-12-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-12-14T21:33:26.881Z" title="Updated 2025-12-15 05:33:26">2025-12-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="8. Sharding, Facebook and Implementation"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="分片-sharding">分片 (Sharding)</h2>
<p>分片是分布式系统设计中的一个关键概念, 它与复制(Replication)一起, 构成了构建大规模系统的基础;</p>
<h3 id="分片的本质与目标">分片的本质与目标</h3>
<p>分片的本质在于解决单一机器的<strong>限制</strong>和<strong>不可靠性</strong>问题,;</p>
<ul>
<li><strong>复制(Replication)</strong>: 通过复制数据来使机器<strong>可靠(reliable)</strong>, 提高容错性;</li>
<li><strong>分片(Sharding)</strong>: 通过分割数据来提高机器的容量限制 (raise the machine’s limits);
<ul>
<li>分片适用于任何存储系统, 通常是通过将 <strong>键空间(key space)</strong> 分割到多个复制对(例如主/备份对)来实现;</li>
</ul>
</li>
</ul>
<h3 id="facebook-架构中的分片应用">Facebook 架构中的分片应用</h3>
<ul>
<li><strong>复制存储</strong>: 数据库在所有数据中心之间进行<strong>复制(replicated)</strong>, 可以想象每个数据中心都包含一份完整的数据拷贝,;</li>
<li><strong>数据库分割</strong>: 数据库被分割成多个<strong>分片(shards)</strong>, 每个数据元素都属于一个特定的分片,;<br>
    - <strong>领导者/跟随者</strong>: 每个分片都有一个数据中心作为其<strong>领导者(leader)</strong>, 其余的中心是<strong>跟随者(followers)</strong>;<br>
    - <strong>数量</strong>: 分片的数量通常<strong>远多于(many more)<strong>数据中心的数量;<br>
    - <strong>负载均衡</strong>: 分片被分配到不同的数据中心以实现</strong>负载均衡(load balance)</strong>;</li>
<li><strong>写入和排序</strong>:<br>
    - 对某一元素的更新操作总是发送给该元素所在分片的<strong>领导者(shard leader)</strong>;<br>
    - 分片领导者负责提供<strong>写入的排序(write ordering) 和 序列化(serialized)</strong>;<br>
    - <strong>sync</strong>: <strong>写入</strong> 领导者的操作是<strong>同步(synchronous)</strong> 的, 当写入返回时, 对象就被持久存储了;<br>
    - <strong>async</strong>: 领导者会将更新发送给跟随者, 但这是 <strong>异步(asynchronously)</strong> 进行的;</li>
</ul>
<p>这种分片和异步复制的结合, 使得 Facebook 能够实现低延迟的写入, 但同时也意味着其他数据中心(跟随者)可能会看到<strong>旧值(old values)</strong>, 这 <strong>不具备线性一致性</strong>;</p>
<h3 id="precedence-graph">Precedence Graph</h3>
<p>类似于我们在数据库系统中看到的 <strong>precedence graph(优先图)</strong>, Facebook 使用一种称为 <strong>Happens-Before Graph</strong> 的机制来跟踪操作的顺序;</p>
<ol>
<li>创建顶点(Vertices): 为每一次操作(读或写)创建一个顶点;</li>
<li>添加边(Edges): 在操作之间添加边, 有两种情况:
<ul>
<li>时序边: 如果操作 Op2 是在 Op1 的响应 <strong>被接收之后</strong> 才发出的, 则从 Op1 到 Op2 添加一条边;</li>
<li>数据依赖边: 如果操作 Op2 <strong>读取了</strong> Op1 写入的值, 则从 Op1 到 Op2 添加一条边;</li>
</ul>
</li>
<li>简化图和检测违规:  在构建完包含所有时序和数据依赖关系的图之后, 需要进行简化和检测
<ol>
<li><strong>合并</strong> 读取到写入: 将每一次读取操作合并到 <strong>产生该读取值的对应的写入</strong> 中;</li>
<li>检测循环: 如果在这个合并后的图结构中检测到 <strong>循环 (cycle)</strong>, 则表示违反了线性一致性 (linearizability violation);</li>
</ol>
</li>
</ol>
<p>尽管 Facebook 的系统并未设计成线性一致性, 但通过这种检测发现, 只有极少数(0.0004%)的读取操作违反了线性一致性;然而, 这个事实本身意味着系统不提供线性一致性;</p>
<h2 id="从车库的小引擎到世界第一互联网企业">从车库的小引擎到世界第一互联网企业</h2>
<p>名字起的大了点, 我们主要是想要讨论如何将小型的分布式系统逐步扩大到横跨全球的分布式集群:</p>
<p>要实现系统的真正扩展, 需要改变此前课程中的假设;</p>
<ul>
<li>此前的假设: 所有副本都拥有 <strong>完整</strong> 的状态(即每个副本都有每个键的值, 也就是 Replicated State);</li>
<li>扩展需求: 为了扩展, 系统需要:
<ol>
<li>对状态进行分区 (Partition / split state);</li>
<li>将 partition 映射到 server 上;</li>
<li>需要有一种方法来 <strong>查找</strong> 哪个服务器拥有特定的分区;<br>
查找分区的方法可以通过数据本身描述, 通过增加复杂度的&quot;定位服务&quot;, 或者简单地持续尝试直到找到为止;</li>
</ol>
</li>
</ul>
<p>那么如何分区存储呢?</p>
<ul>
<li>简单策略: 将学生的成绩单存储在 13 台服务器上, 根据姓氏首字母(如 A 或 B)进行分配;</li>
<li>问题: 这种简单策略会导致负载在服务器之间出现倾斜(<strong>Skew in load</strong>), 可能造成高达 10 倍的差异 因为大多数数据都嵌入了倾斜或模式;</li>
</ul>
<p>为了解决负载倾斜的问题, 分布式系统必须采用更复杂的 <strong>哈希</strong> 和分区策略(例如模哈希或一致性哈希, 这些内容将在后续介绍);</p>
<h2 id="distributed-hashing-and-consistent-hashing">Distributed Hashing and Consistent Hashing</h2>
<h3 id="模哈希-modulo-hashing">模哈希 (Modulo Hashing)</h3>
<ol>
<li>模哈希机制
<ul>
<li>步骤: 对数据的键(key)应用加密哈希函数, 然后对服务器数量 N 取模 (modulo);</li>
<li>存储位置: 将 (键, 值) 对存储在 <code>hash(key) mod N</code> 对应的服务器上;</li>
<li>前提: 必须选择一个具有足够 <strong>熵(entropy)</strong> 的键;好的加密哈希函数会使得输出看起来是 <strong>随机的</strong>;</li>
</ul>
</li>
<li>模哈希的缺陷 (N 变化的影响)
<ul>
<li>模哈希的主要局限在于它 <strong>对系统成员变更的适应性极差</strong>:</li>
<li>N 变化: 当服务器数量 N 改变时(例如, 添加或移除一台机器), 几乎所有键的映射都会改变;</li>
<li>大规模迁移: 这需要系统传输几乎所有(almost all)的值到新的服务器或新的位置, 导致数据迁移量巨大, 效率极低;</li>
</ul>
</li>
</ol>
<h3 id="一致性哈希-consistent-hashing">一致性哈希 (Consistent Hashing)</h3>
<ol>
<li><strong>环形空间</strong> 与映射
<ul>
<li>环形表示: 将哈希空间表示为一个圆环(circle),;</li>
<li>服务器定位: 为每个服务器分配一个随机 ID(从键空间中抽取), 对该 ID 进行哈希, 并将其定位在环上;</li>
<li>分片责任: 每个服务器负责其 <strong>predecessor</strong> 自身之间的键空间;</li>
<li>键的映射: 要映射一个键到一个服务器, 首先对键进行哈希, 然后在环上执行读/写操作, 目标是其 <strong>successor</strong>;</li>
</ul>
</li>
<li>N 变更的 <strong>最小化迁移</strong>
<ul>
<li>一致性哈希的关键优势在于, 当服务器数量发生变化时, 它能 <strong>最大限度地减少</strong> 状态迁移;
<ul>
<li><code>Join</code> 服务器: 新的服务器只会从其后继那里 <strong>分割(splits)</strong> 一部分键空间;</li>
<li><code>Leave</code> 服务器: 被移除服务器的分片将完全转移给其 <strong>successor</strong> 接管;</li>
</ul>
</li>
</ul>
</li>
<li><strong>虚拟节点 (Virtual Nodes)</strong>
<ul>
<li>为了更好地实现负载均衡和容错, 一致性哈希引入了虚拟节点(Virtual Nodes):</li>
<li>机制: 每个服务器获取多个 (例如 v 个) 随机 ID, 每个 ID 对应一个虚拟节点;</li>
<li>优势:
<ul>
<li><strong>Load Balance</strong>: 更大的 v 值可以更好地均匀分布负载 (better load balancing), 使分片更可能均匀分布;</li>
<li><strong>Adaptive to Different v</strong>: 可以根据服务器性能(异构性)调整 v 值(更强大的节点 v 值更高);</li>
<li><strong>Fault Tolerance</strong>: 当一个服务器失败时, 其多个虚拟节点对应的分片会被不同的后继节点接管(v 个后继接管), 避免单一节点承受全部负载;</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="分布式哈希表-distributed-hash-tables-dht">分布式哈希表 (Distributed Hash Tables, DHT)</h3>
<p>一致性哈希定义了键到服务器的分配规则, 但要在大规模分布式系统中使用它, 客户端需要一种可扩展的方式来定位负责特定键的服务器;</p>
<p><strong>Chord 协议</strong> 是 DHT 的一个典型示例, 它旨在实现对任何键的负责节点的可扩展查找, 目标是将查找时间从线性时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> 优化到对数时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>;</p>
<p>查找面临的挑战(两个极端), 在设计查找机制时, 系统需要在两个极端之间进行权衡:<br>
- <strong>中心化 (Centralized)</strong> 方法: 某些机器知道系统中所有节点的位置 (O(N) 空间), 查找速度极快(O(1) 时间), 但维护集中状态困难;<br>
- 这就是我们的 P4 <code>shardmaster</code> 的设计思路;<br>
- <strong>后继指针 (Successor Pointer)</strong> 方法: 每个节点只知道其后继节点 (O(1) 空间), 但查找可能需要遍历整个环, 最坏情况下时间复杂度为 O(N);</p>
<h3 id="chord-协议">Chord 协议</h3>
<p>Author: Ion Stoica (罗马尼亚超人), Robert Morris (388 蠕虫仙人), David Karger, M. Frans Kaashoek, and Hari Balakrishnan</p>
<h4 id="指纹表-finger-tables">指纹表 (Finger Tables)</h4>
<p>Chord 协议通过引入 <strong>指纹表(Finger Tables)</strong> 来解决 O(N) 查找效率低的问题, 实现了类似二叉搜索的查找优化:</p>
<ul>
<li><strong>基于排序</strong>: 键和节点在哈希环上都是有序的;</li>
<li><strong>指针数量</strong>: 每个节点维护 O(logN) 个指针指向其他节点;</li>
<li><strong>指纹表的构建</strong>: 每个节点的指纹表包含指向哈希环上特定距离的 successor 的 <strong>指针</strong>, 这些距离是 2 的幂次 (例如, 1/2, 1/4, 1/8…直到后继节点本身);
<ul>
<li>节点 n 的第 i 个条目指向 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>+</mo><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding="application/x-tex">hash(n)+2^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.824664em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span></span></span> 的后继节点;</li>
</ul>
</li>
</ul>
<h4 id="使用指纹表进行查找-lookup-with-finger-tables">使用指纹表进行查找 (Lookup with Finger Tables)</h4>
<p>查找过程通过递归地使用指纹表进行:</p>
<ol>
<li>基本情况(Base Case): 如果目标键 k 属于当前节点的 <strong>successor</strong> 分片, 则返回该后继节点,;</li>
<li>归纳步骤(Inductive Step): 如果键 k 在其他范围内, 则在当前节点的指纹表中, <strong>查找最远且不超过 k 的那个节点</strong>;然后将查找请求转发给该节点(即&quot;在低端节点进行查找&quot;);</li>
<li><strong>查找效率</strong>: 通过这种机制, 每一次查找都能消除哈希环上剩余范围的一半 (至少), 从而在最坏情况下将查找时间复杂度降低到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>;</li>
</ol>
<p>然而, 即使是 O(log N) 的查找, 在节点数量巨大(如 100 万节点需要 20 跳)且节点跨地域部署时, 网络延迟的叠加仍然可能导致较长的实际查找时间 (例如 20 跳可能耗时 1 秒);</p>
<h4 id="example">Example</h4>
<ul>
<li>哈希空间位数 <code>m = 8</code>, 因此 ID 在环上属于区间 <code>[0, 256)</code>(首尾相接);</li>
<li>当前存在的节点(按顺时针从小到大排序): <code>&#123;10, 42, 80, 120, 160, 200, 230&#125;</code></li>
</ul>
<p>定义: <code>successor(x)</code>: 从 <code>x</code> 出发沿顺时针方向遇到的第一个节点;</p>
<p>Chord 在节点 <code>n</code> 的 finger table 定义:</p>
<ul>
<li><code>finger[i] = successor(n + 2^i mod 2^m)</code>, 其中 <code>i = 0..m-1</code>;</li>
</ul>
<p>计算 <code>start_i = 80 + 2^i (mod 256)</code>, 再取 <code>successor(start_i)</code>:</p>
<ul>
<li><code>i = 0</code>: start = 81  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(81)  = 120</li>
<li><code>i = 1</code>: start = 82  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(82)  = 120</li>
<li><code>i = 2</code>: start = 84  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(84)  = 120</li>
<li><code>i = 3</code>: start = 88  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(88)  = 120</li>
<li><code>i = 4</code>: start = 96  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(96)  = 120</li>
<li><code>i = 5</code>: start = 112 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(112) = 120</li>
<li><code>i = 6</code>: start = 144 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(144) = 160</li>
<li><code>i = 7</code>: start = 208 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> successor(208) = 230</li>
</ul>
<p>结论: 节点 <strong>80</strong> 的指表大多数项都指向 <strong>120</strong>, 较远的两项指向 <strong>160</strong> 和 <strong>230</strong>;</p>
<p>在当前节点 <code>n</code>:</p>
<ol>
<li>令 <code>s = successor(n)</code>;</li>
<li>如果 <code>id $\in$ (n, s]</code>(顺时针区间), 则返回 <code>s</code>, 查找结束;</li>
<li>否则, 从 finger table 里选择 <strong>closest preceding finger</strong>(“最接近但不超过目标的指针”):
<ul>
<li>选一个 finger 指向的节点 <code>f</code>, 满足 <code>f $\in$ (n, id)</code>(顺时针意义上在 <code>n</code> 和 <code>id</code> 之间), 并且 <code>f</code> 尽量靠近 <code>id</code>;</li>
</ul>
</li>
<li>把请求转发到 <code>f</code>, 重复上述过程;</li>
</ol>
<p><strong>从节点 80 开始查找 <code>id = 190</code></strong></p>
<ul>
<li><code>successor(80) = 120</code>, <code>190 $\in$ (80, 120]</code> 吗? False.</li>
<li>选 closest preceding finger(在 <code>(80,190)</code> 里且最接近 190):
<ul>
<li>finger 候选: <code>120</code>, <code>160</code> (<code>230</code> 超过 190, 不能选) -&gt; 选择 <strong>160</strong></li>
</ul>
</li>
<li>转发: <code>80 $\rightarrow$ 160</code>, <code>successor(160) = 200</code>; <code>190 $\in$ (160, 200]</code> 吗? True</li>
</ul>
<p>因此答案: <code>successor(190) = 200</code></p>
<p>路径: <code>80 $\rightarrow$ 160 $\rightarrow$ 200(命中)</code></p>
<p>备注: 和 “按 1/2, 1/4… 区间缩小” 的关系</p>
<ul>
<li>finger table 的 <code>2^i</code> 让你拥有&quot;指数级跨度&quot;的跳点 (粗到细);</li>
<li>但查找时不是显式找&quot;落在哪个 1/2^k 区间&quot;, 而是选 <strong>closest preceding finger</strong> 来逼近目标;</li>
<li>终止条件也不是&quot;指针里直接命中目标&quot;, 而是当目标落入 <code>(n, successor(n)]</code> 这一段时直接返回 <code>successor(n)</code>;</li>
</ul>
<h2 id="dynamo-系统-amazon-的分布式键值存储">Dynamo 系统 (Amazon 的分布式键值存储))</h2>
<ul>
<li>Dynamo 核心原则:
<ul>
<li>延迟: 关注 <strong>尾延迟(tail latency)</strong>, 因为网页运行速度取决于最慢的响应, 中位数延迟不重要;</li>
<li>无特殊节点: 系统中 <strong>没有</strong> 被指定为 “特殊” 的中心化节点;</li>
<li>应用权衡: 赋予应用程序在一致性, <strong>可用性和延迟</strong> 之间进行权衡的杠杆;</li>
<li>因果追踪: 使用 causality 来追踪发散的更新版本;</li>
<li>应用语义修复: 使用应用程序的语义知识来解决 conflict;</li>
</ul>
</li>
</ul>
<h3 id="尾延迟-first-contribution-tail-latency">尾延迟 (First Contribution: Tail Latency)</h3>
<p>Dynamo 系统的设计理念对分布式系统社区的一大贡献是强调了 <strong>尾延迟(Tail Latency)</strong> 的重要性, 而非传统的平均或中位数延迟;</p>
<ul>
<li>尾延迟的价值: 因此, Dynamo 强调应该关注尾延迟(tail latency), 例如延迟测量的 99.9% 分位数; 这对于提升用户体验更具实际意义;</li>
</ul>
<h3 id="dynamo-中的一致性哈希和复制-consistent-hashing-in-dynamo">Dynamo 中的一致性哈希和复制 (Consistent Hashing in Dynamo)</h3>
<p>Dynamo 在一致性哈希(Consistent Hashing, CH) 的基础上添加了 <strong>replication 和 virtual 节点</strong>, 使其具备 <strong>容错性</strong> 和 <strong>耐久性</strong>;</p>
<ul>
<li>复制(Replication): 基础的分布式哈希表 (DHT) 通常假设单个服务器拥有键, 不具备容错性;Dynamo 通过为每个键配置 N 个后继节点作为副本 (N 是可配置参数) 来增加复制; 更大的 N 值可以提高数据的耐久性(durability)(即不丢失更新的概率);</li>
<li>虚拟节点(Virtual Nodes): Dynamo 使用虚拟节点来解决负载均衡问题;它会跳过重复的服务器(即如果同一台服务器拥有多个虚拟节点), 以确保副本的独立性;</li>
</ul>
<h3 id="法定人数管理与权衡-quorum-management">法定人数管理与权衡 (Quorum Management)</h3>
<p>Dynamo 使用 quorum 来管理读写操作, 允许应用程序选择一致性模型:</p>
<ul>
<li><strong>Coordinator</strong>: 客户端将 Put 请求路由到 N 个后继节点中的一个, 该节点充当写入的协调器 (coordinator), 并将更新发送给其他 <code>N−1</code> 个副本;</li>
<li><strong>读写参数</strong>:
<ul>
<li>写入操作等待 W 个响应才算成功(包括协调器自己的响应);</li>
<li>读取操作等待 R 个响应才算成功(包括协调器自己的响应);</li>
</ul>
</li>
<li><strong>权衡</strong>:
<ul>
<li>最大化可用性/最小化延迟: 选择 <strong>较低</strong> 的 R 和 W 值;</li>
<li>提供一致性: 如果设置 <code>R+W&gt;N</code>, 则形成了 quorum (这里是鸽笼原理), 可以确保读取操作看到最近提交的写入
<ul>
<li>不过这里由于 Dynamo 强调可用性, 支持并发写入, 所以可能会出现多个版本都是最新版的情况;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="去中心化与-gossip-协议">去中心化与 Gossip 协议</h3>
<p>为了实现 “无特殊节点” 的原则, Dynamo 采用了 <strong>Gossip</strong> 协议来交换节点信息:</p>
<ul>
<li>机制: 服务器 <strong>定期随机选择一个</strong> 通信对象, 彼此交换服务器信息和虚拟节点 ID;</li>
<li>优势: 该协议是完全去中心化的, 且随机选择 reaches saturation quickly;</li>
<li>后果: 由于信息达到&quot;完整&quot;需要时间, N 个负责节点中的任何一个都可以作为协调器;这允许某些节点可能稍微过时, 并且由于没有单一节点来排序操作, <strong>版本可能会发散(diverge)</strong>;</li>
</ul>
<p>为了解决这个版本发散的问题, Dynamo 使用了 <strong>Vector Clock</strong> 来追踪更新的因果关系, 也就是类似 Eventual Consistency 里的同步一致性机制;</p>
<h3 id="向量时钟-vector-clocks-in-dynamo">向量时钟 (Vector Clocks in Dynamo)</h3>
<p>由于版本可能发散(冲突), Dynamo 必须使用一种机制来追踪更新的因果关系, 以便解决冲突;它使用了向量时钟的一个变体;</p>
<ul>
<li>标准 VC 的问题: 标准的向量时钟的 vec 长度与系统中的服务器数量成正比, 在大规模系统中不具备可扩展性(<strong>not scalable</strong>);</li>
<li>Dynamo 的变体: Dynamo 使用了向量时钟的一个变体;它不存储系统中所有服务器的计数器, 而是存储一个 <strong>(协调器节点, 计数器) 对</strong> 的列表;
<ul>
<li>内容: 该列表只追踪那些具有 <strong>非零值的节点</strong>;</li>
<li>含义: 计数器记录了由该协调器节点管理的 <strong>更新数量</strong>;</li>
<li>示例: 例如 [(A, 1), (B, 3), …], 其中 A 和 B 是更新的协调器节点;</li>
</ul>
</li>
</ul>
<h4 id="通过上下文传输向量时钟-transmitting-vector-clocks-via-context">通过上下文传输向量时钟 (Transmitting Vector Clocks via Context)</h4>
<p>为了实现向量时钟的追踪, Dynamo 修改了传统的客户端接口, 要求客户端在读写操作中传递向量时钟信息:</p>
<ul>
<li>Get 操作: Get(key) 操作返回 [value, vector clock], 即返回键的值和当前已知的向量时钟,;</li>
<li>Put 操作: 后续的 Put 操作需要将获取到的 vector clock 作为上下文发送回服务器: Put(key, value, vector clock);</li>
</ul>
<p>向量时钟在副本中的用途主要有两个目的:<br>
1. 解决冲突 (Resolving Conflicts): 向量时钟用于判断两个版本的关系:<br>
- <strong>Causality</strong>: 如果向量时钟显示两个更新具有因果关系(即第二个更新是基于第一个更新的), 则第二个更新取代第一个更新, 第一个版本可以被丢弃(垃圾回收),;<br>
- <strong>Concurrency Conflict</strong>: 如果向量时钟显示两个更新是并发的 (即它们之间没有因果关系), 则服务器必须保留所有冲突的值 (存储多个版本);<br>
2. 垃圾回收 (Garbage Collecting Old Values): 通过确定一个版本被另一个版本取代后, 可以安全地将旧版本从存储中清除,;</p>
<h3 id="冲突的解决方式-resolve-conflicts">冲突的解决方式 Resolve Conflicts</h3>
<p>一旦识别出并发冲突, Dynamo 允许在不同的抽象层级进行解决:</p>
<ol>
<li>
<p>系统层解决(System-Layer Resolution) 可以在系统层面上指定一个默认的解决策略, 例如**“最后写入者获胜”(last writer wins)**;</p>
</li>
<li>
<p>应用语义解决(Application Semantics) Dynamo 更鼓励基于应用程序语义的冲突解决, 借鉴了 <strong>Bayou</strong> 经验:</p>
<ul>
<li>客户端协调: 当多个版本存在并发冲突时, Dynamo 会将所有冲突的值返回给客户端;</li>
<li>客户端决策: 客户端可以利用应用程序的语义知识来决定如何处理这些冲突, 例如对于购物车数据, 可以通过取商品数量的<strong>最大值(union)</strong> 来解决冲突;</li>
</ul>
</li>
<li>
<p>服务器存储多个现实 (Multiple Realities)<br>
如果应用程序负责解决冲突, 那么服务器就必须集体存储所有冲突的值(即&quot;多个现实&quot;);</p>
</li>
</ol>
<ul>
<li>反熵机制的作用: 由于节点使用反熵机制学习到此前错过的操作, 如果这些错过的操作是并发发生的, 服务器必须保留所有这些版本, 直到客户端通过后续的 Put 操作解决了它们;</li>
</ul>
<h3 id="反熵-anti-entropy">反熵 (Anti-Entropy)</h3>
<p>节点的状态会随着时间而发散(diverge)或落后(out of date);反熵机制就是用来解决这种数据滞后问题的;</p>
<h4 id="滞后的原因与传统系统的对比">滞后的原因与传统系统的对比</h4>
<ul>
<li><strong>out-of-date</strong> 滞后性: 在 Dynamo 中, 如果一个节点错过了一个更新, 并且此后没有针对该键的新值提交, 那么这个滞后的节点可能永远不会追赶上来 (catch up); Dynamo 并非为了最终更新而设计成最终一致性的;</li>
<li>Paxos 的解决方式: 相比之下, 像 Paxos 这样的系统要求集群就所有操作的顺序达成一致;落后的节点通常在处理它的下一个操作时就自动追赶上来了; <strong>Dynamo 没有等效的机制</strong>;</li>
<li>EC 解决方式: 通过定义一个 log 并且来交换 version vectors 来支持合并, 但是 Dynamo 没有 log</li>
</ul>
<h4 id="反熵机制的原理">反熵机制的原理</h4>
<p>为了确保所有节点最终收敛到一致的状态, Dynamo 节点会定期执行反熵操作:</p>
<ul>
<li>信息交换: 节点会定期交换关于它们共享分片的信息;</li>
<li>原则上: 理想情况下, 它们会比较分片中所有的 (key, value, timestamp) 条目, 并复制任何一方有而另一方缺失的条目;</li>
</ul>
<p>回忆一下我们在 p4 的实现过程中有一个自定义的 <code>equals</code> 函数, 也就是要求对所有的 slice 和 map 都要逐一对比每个元素是否相等, 那么这里就有问题了, 超大数据的情况下我们不应该完全逐个对比, 这会非常低效; 因为一组的不同 shard 之间的差异应该是非常 sparse 的, 逐个对比大部分时间是浪费的;</p>
<p>所以我们要借助 tree 结构来二分找差异性, 并且在每个子树中使用 hash 来快速对比;</p>
<h4 id="merkle-tree">Merkle Tree</h4>
<ul>
<li>树按 <code>key space</code> 切分: 根覆盖整个空间(图里是 [0, 2^128) 这种大范围)</li>
<li>左孩子覆盖前一半区间, 右孩子覆盖后一半区间</li>
<li>继续递归切分, 直到叶子覆盖很小的区间(或覆盖一个 bucket)</li>
</ul>
<p>每个树节点存一个 hash(摘要), 常见构造是:<br>
- 叶子: 对该区间内的所有 (key,value)(按固定顺序)做一个摘要<br>
- 内部节点: hash( left_hash || right_hash )</p>
<p>为了减少运算量, 一般从 root 开始比较, 相同就 prune 掉, 不同就继续往下比较</p>
<h3 id="节点加入-离开可能非常昂贵-node-joins-leaves-can-be-expensive">节点加入/离开可能非常昂贵 (Node Joins/Leaves Can Be Expensive)</h3>
<ol>
<li>
<p>昂贵的原因: 抽象耦合<br>
在现有的模型下, 如果要 join/leave, 可能包含的成本有: 读取所有的 kvStore 找到对应的 key 范围; 然后复制数据到新的结构并且发送给新的节点; 重新计算 Merkle Tree 等等; 而且注意 Dynamo 明确指出要重视 <strong>Tail Latency</strong>, 所以这样的行为不可接受;<br>
导致复杂性的根本原因是 Dynamo <strong>使用单一 mechanism 来完成两个不同的 abstract</strong>:</p>
<ol>
<li>键空间的 分区(Partitioning of the key space): 将数据状态分割成多个区块;</li>
<li>键到服务器的 放置(Placement of keys to servers): 将这些区块分配给特定的服务器;</li>
<li>由于这两个抽象是 <strong>耦合的</strong>, 因此每一次添加或移除节点, 都会同时修改分区和放置规则;</li>
</ol>
</li>
<li>
<p>解决方案: 解耦分区和放置<br>
为了降低节点变更的成本和复杂性, 可以采取解耦分区和放置的策略:</p>
</li>
</ol>
<ul>
<li><strong>静态分区</strong>: 将键空间静态地划分为等大小的分片(shards); 类似于我们的 p4 实现的 16 个固定 shard;</li>
<li><strong>分片放置 (placement)</strong>: 然后将这些分片 map 到 N 个虚拟节点上;</li>
<li><strong>分离存储和管理</strong>: 每个分片可以单独存储, 并维护自己的默克尔树 (shard level);</li>
<li><strong>迁移简化</strong>: 当节点加入或离开时, 系统只需要在节点之间交接分片/默克尔树, 而不是动态地重新计算哈希环上的分片范围;</li>
</ul>
<h3 id="hinted-handoff">Hinted Handoff</h3>
<p>专门处理那些被写入到偏好列表 M 中, 但不属于该键的原始 N 个负责节点的更新; 这些更新被称为&quot;远端更新&quot;(far updates);</p>
<ol>
<li>运作原理
<ol>
<li>临时存储: 当协调器发现一个属于 N 节点的更新无法写入到该节点时(例如节点暂时不可达), 它会将该更新转发给 M 列表中可用的, 但不属于 N 集合的某个节点 (例如节点 E);</li>
<li>标记原始目的地: 这个更新会在临时存储它的节点(节点 E)上被 <strong>标记(tagged)</strong> 上其&quot;原始目的地&quot;(original destination, 即 N 集合中不可达的那个节点 C);</li>
<li>转发数据: 当原始目的地节点(节点 C)再次可用时, 临时存储节点(节点 E)会将这个数据更新 <strong>转发(forwards)</strong> 回给节点 C;</li>
<li>遗忘: 一旦数据成功转发给原始目的地 C 并被确认接收, 临时存储节点 E 就可以 <strong>遗忘(forgotten)</strong> 这个数据了;</li>
</ol>
</li>
<li>目标: 提示移交的目的是保证即使在节点瞬时故障期间, 写入操作也能完成(最大化可用性), 并且保证数据最终会被送到正确的, 负责持久存储它的 N 个节点之一(最大化耐久性);</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Yuchen You (Wesley)</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/12/13/wesley_knowledge_repo/ds/8.sharding/">http://example.com/2025/12/13/wesley_knowledge_repo/ds/8.sharding/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/distributed-sys/">distributed_sys</a></div><div class="post_share"><div class="social-share" data-image="/img/me_new.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/12/13/wesley_knowledge_repo/ds/7.eventual_consistency/" title="7. Eventual Consistency"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">7. Eventual Consistency</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2025/05/07/wesley_knowledge_repo/os/mit_cs824/1.%20MapReduce,%20Simplified%20Data%20Processing%20on%20Large%20Clusters/" title="1. Map Reduce, Simplified Data Processing on Large Clusters"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-07</div><div class="title">1. Map Reduce, Simplified Data Processing on Large Clusters</div></div></a></div><div><a href="/2025/05/07/wesley_knowledge_repo/os/Apache/1.%20Kafka/" title="1. Kafka"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-08</div><div class="title">1. Kafka</div></div></a></div><div><a href="/2025/05/08/wesley_knowledge_repo/os/mit_cs824/2.%20The%20Design%20of%20a%20Practical%20System%20for%20Fault-Tolerant%20Virtual%20Machines/" title="2. The Design of a Practical System for Fault-Tolerant Virtual Machines"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-09</div><div class="title">2. The Design of a Practical System for Fault-Tolerant Virtual Machines</div></div></a></div><div><a href="/2025/05/10/wesley_knowledge_repo/os/mit_cs824/0.%20Hadoop%20Distributed%20File%20System/" title="0. Hadoop Distributed File System"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-10</div><div class="title">0. Hadoop Distributed File System</div></div></a></div><div><a href="/2025/05/13/wesley_knowledge_repo/os/OrderLab/2.%20Predictive%20and%20Adaptive%20Failure%20Mitigation%20to%20Avert%20Production%20Cloud%20VM%20Interruptions/" title="2. Predictive and Adaptive Failure Mitigation to Avert Production Cloud VM Interruptions"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-13</div><div class="title">2. Predictive and Adaptive Failure Mitigation to Avert Production Cloud VM Interruptions</div></div></a></div><div><a href="/2025/05/12/wesley_knowledge_repo/os/OrderLab/1.%20AIOpsLab%20A%20Holistic%20Framework%20to%20Evaluate%20AI%20Agents%20for%20Enabling%20Autonomous%20Clouds/" title="1. AIOpsLab: A Holistic Framework to Evaluate AI Agents for Enabling Autonomous Clouds"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-12</div><div class="title">1. AIOpsLab: A Holistic Framework to Evaluate AI Agents for Enabling Autonomous Clouds</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/me_new.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Yuchen You (Wesley)</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">302</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/1WesleyYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/1Wesleyyou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yuchenxr@umich.edu" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/yuchen-you-a74940314/?locale=en_US" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #4a4dbe;"></i></a><a class="social-icon" href="/Yuchen_CV.pdf" target="_blank" title="CV"><i class="fas fa-address-card" style="color: #251456;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%87-sharding"><span class="toc-number">1.</span> <span class="toc-text">分片 (Sharding)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E7%9A%84%E6%9C%AC%E8%B4%A8%E4%B8%8E%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">分片的本质与目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#facebook-%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%9A%84%E5%88%86%E7%89%87%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Facebook 架构中的分片应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#precedence-graph"><span class="toc-number">1.3.</span> <span class="toc-text">Precedence Graph</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E8%BD%A6%E5%BA%93%E7%9A%84%E5%B0%8F%E5%BC%95%E6%93%8E%E5%88%B0%E4%B8%96%E7%95%8C%E7%AC%AC%E4%B8%80%E4%BA%92%E8%81%94%E7%BD%91%E4%BC%81%E4%B8%9A"><span class="toc-number">2.</span> <span class="toc-text">从车库的小引擎到世界第一互联网企业</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#distributed-hashing-and-consistent-hashing"><span class="toc-number">3.</span> <span class="toc-text">Distributed Hashing and Consistent Hashing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%93%88%E5%B8%8C-modulo-hashing"><span class="toc-number">3.1.</span> <span class="toc-text">模哈希 (Modulo Hashing)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C-consistent-hashing"><span class="toc-number">3.2.</span> <span class="toc-text">一致性哈希 (Consistent Hashing)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%93%88%E5%B8%8C%E8%A1%A8-distributed-hash-tables-dht"><span class="toc-number">3.3.</span> <span class="toc-text">分布式哈希表 (Distributed Hash Tables, DHT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chord-%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.4.</span> <span class="toc-text">Chord 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E7%BA%B9%E8%A1%A8-finger-tables"><span class="toc-number">3.4.1.</span> <span class="toc-text">指纹表 (Finger Tables)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8C%87%E7%BA%B9%E8%A1%A8%E8%BF%9B%E8%A1%8C%E6%9F%A5%E6%89%BE-lookup-with-finger-tables"><span class="toc-number">3.4.2.</span> <span class="toc-text">使用指纹表进行查找 (Lookup with Finger Tables)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-number">3.4.3.</span> <span class="toc-text">Example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamo-%E7%B3%BB%E7%BB%9F-amazon-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%AE%E5%80%BC%E5%AD%98%E5%82%A8"><span class="toc-number">4.</span> <span class="toc-text">Dynamo 系统 (Amazon 的分布式键值存储))</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%BE%E5%BB%B6%E8%BF%9F-first-contribution-tail-latency"><span class="toc-number">4.1.</span> <span class="toc-text">尾延迟 (First Contribution: Tail Latency)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamo-%E4%B8%AD%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E5%92%8C%E5%A4%8D%E5%88%B6-consistent-hashing-in-dynamo"><span class="toc-number">4.2.</span> <span class="toc-text">Dynamo 中的一致性哈希和复制 (Consistent Hashing in Dynamo)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E7%AE%A1%E7%90%86%E4%B8%8E%E6%9D%83%E8%A1%A1-quorum-management"><span class="toc-number">4.3.</span> <span class="toc-text">法定人数管理与权衡 (Quorum Management)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96%E4%B8%8E-gossip-%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.4.</span> <span class="toc-text">去中心化与 Gossip 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E6%97%B6%E9%92%9F-vector-clocks-in-dynamo"><span class="toc-number">4.5.</span> <span class="toc-text">向量时钟 (Vector Clocks in Dynamo)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BC%A0%E8%BE%93%E5%90%91%E9%87%8F%E6%97%B6%E9%92%9F-transmitting-vector-clocks-via-context"><span class="toc-number">4.5.1.</span> <span class="toc-text">通过上下文传输向量时钟 (Transmitting Vector Clocks via Context)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%B2%E7%AA%81%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F-resolve-conflicts"><span class="toc-number">4.6.</span> <span class="toc-text">冲突的解决方式 Resolve Conflicts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E7%86%B5-anti-entropy"><span class="toc-number">4.7.</span> <span class="toc-text">反熵 (Anti-Entropy)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%9E%E5%90%8E%E7%9A%84%E5%8E%9F%E5%9B%A0%E4%B8%8E%E4%BC%A0%E7%BB%9F%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">4.7.1.</span> <span class="toc-text">滞后的原因与传统系统的对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E7%86%B5%E6%9C%BA%E5%88%B6%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.2.</span> <span class="toc-text">反熵机制的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#merkle-tree"><span class="toc-number">4.7.3.</span> <span class="toc-text">Merkle Tree</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5-%E7%A6%BB%E5%BC%80%E5%8F%AF%E8%83%BD%E9%9D%9E%E5%B8%B8%E6%98%82%E8%B4%B5-node-joins-leaves-can-be-expensive"><span class="toc-number">4.8.</span> <span class="toc-text">节点加入&#x2F;离开可能非常昂贵 (Node Joins&#x2F;Leaves Can Be Expensive)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hinted-handoff"><span class="toc-number">4.9.</span> <span class="toc-text">Hinted Handoff</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/13/wesley_knowledge_repo/ds/8.sharding/" title="8. Sharding, Facebook and Implementation">8. Sharding, Facebook and Implementation</a><time datetime="2025-12-13T12:25:03.000Z" title="Created 2025-12-13 20:25:03">2025-12-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/13/wesley_knowledge_repo/ds/7.eventual_consistency/" title="7. Eventual Consistency">7. Eventual Consistency</a><time datetime="2025-12-13T09:00:03.000Z" title="Created 2025-12-13 17:00:03">2025-12-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/13/wesley_knowledge_repo/ds/6.cap/" title="6. 从 FLP 不可能到 CAP 和 PACELC">6. 从 FLP 不可能到 CAP 和 PACELC</a><time datetime="2025-12-13T08:12:15.000Z" title="Created 2025-12-13 16:12:15">2025-12-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/28/wesley_knowledge_repo/ds/9.spanner/" title="9. 分布式事务系统与 Spanner">9. 分布式事务系统与 Spanner</a><time datetime="2025-11-28T12:55:08.000Z" title="Created 2025-11-28 20:55:08">2025-11-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/28/wesley_knowledge_repo/db/5.transaction/" title="5. Transaction and ACID DB">5. Transaction and ACID DB</a><time datetime="2025-11-28T08:50:38.000Z" title="Created 2025-11-28 16:50:38">2025-11-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Yuchen You (Wesley)</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>