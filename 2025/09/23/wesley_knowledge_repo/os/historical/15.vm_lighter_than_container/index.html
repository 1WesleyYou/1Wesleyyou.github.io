<!DOCTYPE html><html lang="en-US" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>15.vm_lighter_than_container | Yuchen You</title><meta name="author" content="Yuchen You (Wesley)"><meta name="copyright" content="Yuchen You (Wesley)"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Introduction   背景  容器(Docker&#x2F;LXC)在工业界广泛应用: Google, AWS, Azure, GCP 都依赖容器; 容器优势:  快速实例化(毫秒~百毫秒) 高密度运行(单机可数千~上万实例) 内存占用小, 镜像体积小 问题  安全性不足:  容器暴露 400+ syscalls, 内核攻击面巨大; 隔离性不如 VM, 常需要&quot;容器运行在 VM 内&amp;quo">
<meta property="og:type" content="article">
<meta property="og:title" content="15.vm_lighter_than_container">
<meta property="og:url" content="http://example.com/2025/09/23/wesley_knowledge_repo/os/historical/15.vm_lighter_than_container/index.html">
<meta property="og:site_name" content="Yuchen You">
<meta property="og:description" content="Introduction   背景  容器(Docker&#x2F;LXC)在工业界广泛应用: Google, AWS, Azure, GCP 都依赖容器; 容器优势:  快速实例化(毫秒~百毫秒) 高密度运行(单机可数千~上万实例) 内存占用小, 镜像体积小 问题  安全性不足:  容器暴露 400+ syscalls, 内核攻击面巨大; 隔离性不如 VM, 常需要&quot;容器运行在 VM 内&amp;quo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/me_new.jpeg">
<meta property="article:published_time" content="2025-09-23T11:03:49.000Z">
<meta property="article:modified_time" content="2025-09-29T17:19:34.022Z">
<meta property="article:author" content="Yuchen You (Wesley)">
<meta property="article:tag" content="operating_system">
<meta property="article:tag" content="virtual_machine">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="container">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/me_new.jpeg"><link rel="shortcut icon" href="/img/hackerrank.svg"><link rel="canonical" href="http://example.com/2025/09/23/wesley_knowledge_repo/os/historical/15.vm_lighter_than_container/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '15.vm_lighter_than_container',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-30 01:19:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/me_new.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">291</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/math_master.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Yuchen You"><img class="site-icon" src="/img/avatar.png"/><span class="site-name">Yuchen You</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">15.vm_lighter_than_container</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-09-23T11:03:49.000Z" title="Created 2025-09-23 19:03:49">2025-09-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-09-29T17:19:34.022Z" title="Updated 2025-09-30 01:19:34">2025-09-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="15.vm_lighter_than_container"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="introduction">Introduction</h2>
<ul>
<li>
<p><strong>背景</strong></p>
<ul>
<li>容器(Docker/LXC)在工业界广泛应用: Google, AWS, Azure, GCP 都依赖容器;</li>
<li>容器优势:
<ul>
<li>快速实例化(毫秒~百毫秒)</li>
<li>高密度运行(单机可数千~上万实例)</li>
<li>内存占用小, 镜像体积小</li>
<li><strong>问题</strong>
<ul>
<li>安全性不足:
<ul>
<li>容器暴露 <strong>400+ syscalls</strong>, 内核攻击面巨大;</li>
<li>隔离性不如 VM, 常需要&quot;容器运行在 VM 内&quot;来补强;</li>
<li>资源滥用(fork bomb, 文件描述符耗尽)可导致宿主机 DoS;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>目标</strong></p>
<ul>
<li>结合容器的轻量性与 VM 的强隔离;</li>
<li>需求:
<ul>
<li>毫秒级实例化</li>
<li>高密度运行</li>
<li>小镜像/低内存占用</li>
<li>快速挂起/恢复</li>
<li>保持 VM 的硬件隔离安全性</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>贡献</strong></p>
<ul>
<li>分析 Xen 性能瓶颈, 重构控制面:
<ul>
<li>移除 XenStore (<strong>noxs</strong>), 消除中心化瓶颈;</li>
<li>新工具链 <strong>chaos/libchaos</strong> + <strong>split toolstack</strong>;</li>
</ul>
</li>
<li>提出 <strong>Tinyx</strong> 工具, 生成极小 Linux VM; 支持 unikernel;</li>
<li>实现 <strong>LightVM</strong></li>
</ul>
</li>
</ul>
<h3 id="tinyx-与-overlayfs">Tinyx 与 OverlayFS</h3>
<ul>
<li>Tinyx 目标: 构建最小化 Linux VM rootfs;</li>
<li>原理:
<ol>
<li>OverlayFS = <code>lowerdir</code> (Debian minimal) + <code>upperdir</code> (空目录);</li>
<li>在合成目录中正常安装 <code>apt-get</code> 包, 写入 upperdir;</li>
<li>卸载 (unmount) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 保留 upperdir 的安装结果;</li>
<li>将 upperdir 覆盖到 BusyBox rootfs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 得到最小 rootfs;</li>
</ol>
</li>
<li>效果: 自动化, 轻量化, 无需完整 Debian 系统;</li>
</ul>
<h3 id="noxs-与-chaos-toolstack">Noxs 与 Chaos Toolstack</h3>
<ul>
<li>
<p><strong>传统 Xen 网络启动流程 (图 7a)</strong>:</p>
<ol>
<li>工具栈写 XenStore <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 注册新 VM;</li>
<li>后端驱动监听 XenStore, 返回 event channel &amp; grant ref;</li>
<li>前端驱动启动后去 XenStore 拉取信息;</li>
<li>前后端共享内存, 事件通道传递数据;</li>
</ol>
<ul>
<li>缺点: 大量 XenStore 交互 (30+ 条记录), 性能瓶颈;</li>
</ul>
</li>
<li>
<p><strong>LightVM noxs/chaos 流程 (图 7b)</strong>:</p>
<ol>
<li>chaos 工具链发 ioctl 请求后端创建设备;</li>
<li>后端返回 event channel &amp; grant ref;</li>
<li>chaos 通过 hypercall 将信息写入 VM 的 <strong>device page</strong>;</li>
<li>前端驱动启动时, 直接映射 device page, 获取通信信息;</li>
<li>前后端通过事件通道通知, 绕过 XenStore;</li>
</ol>
</li>
<li>
<p>优点: 去中心化, 低延迟, 可扩展;</p>
</li>
</ul>
<h3 id="设备页映射-device-page-mapping">设备页映射 (Device Page Mapping)</h3>
<ul>
<li><strong>概念</strong>: hypervisor 为每个 VM 分配一张 <strong>只读设备页</strong>;</li>
<li><strong>过程</strong>:
<ul>
<li>前端启动时 hypercall 请求地址, 将设备页映射到虚拟地址空间;</li>
<li>前端驱动读取其中的 backend-id, event channel, grant ref;</li>
<li>据此完成 ring buffer 映射和 event channel 绑定;</li>
</ul>
</li>
<li><strong>意义</strong>: 设备初始化无需 XenStore, 直接 guest<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>↔</mo></mrow><annotation encoding="application/x-tex">\leftrightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">↔</span></span></span></span>hypervisor 通信;</li>
</ul>
<h3 id="sysctl-伪设备">Sysctl 伪设备</h3>
<ul>
<li>用途: 处理 <strong>电源管理类操作(suspend/resume/shutdown/migration)</strong>;</li>
<li>架构:
<ul>
<li>sysctlback 在 Dom0</li>
<li>sysctlfront 在 VM</li>
<li>双方通过 <strong>共享设备页 + event channel</strong> 通信;</li>
</ul>
</li>
<li>在迁移中:
<ul>
<li>chaos 对 sysctlback 发 ioctl <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 标记 suspend <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 触发事件;</li>
<li>sysctlfront 收到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> guest 保存状态并解绑设备页/event channel;</li>
<li>VM 进入可迁移状态;</li>
</ul>
</li>
</ul>
<h3 id="tcp-connection-在迁移中的作用">TCP Connection 在迁移中的作用</h3>
<ul>
<li><strong>流程</strong>:
<ol>
<li>chaos 在源端与目标宿主机的迁移守护进程建立 <strong>TCP 连接</strong>;</li>
<li>首先传输 guest 配置信息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 目标端预建 domain &amp; devices;</li>
<li>通过 sysctl 触发 guest suspend;</li>
<li>使用 libxc 将 VM 内存+CPU 状态通过 <strong>TCP 管道</strong>传送至目标端;</li>
<li>目标端 resume VM;</li>
</ol>
</li>
<li><strong>目的</strong>:
<ul>
<li>简单, 通用(任何两台主机都可通信);</li>
<li>提供可靠传输, 保证迁移状态正确;</li>
</ul>
</li>
<li><strong>测试指标</strong>: 迁移总时延 = save + transfer + restore;</li>
</ul>
<h3 id="checkpointing-与-migration">Checkpointing 与 Migration</h3>
<ul>
<li>
<p><strong>Checkpoint (Save/Restore)</strong>:</p>
<ul>
<li>Save = VM 冻结 + 状态写出;</li>
<li>Restore = 状态加载 + VM 继续执行;</li>
<li>LightVM: Save ~30ms, Restore ~20ms</li>
<li>标准 Xen: Save ~128ms, Restore ~550ms</li>
<li>用途: 单机快速暂停/恢复 VM;</li>
</ul>
</li>
<li>
<p><strong>Migration</strong>:</p>
<ul>
<li>跨机器: Save + 网络传输 + Restore;</li>
<li>LightVM: ~60ms, 不随 VM 数量增加而变慢;</li>
<li>标准 Xen: 数百毫秒~秒级;</li>
<li>用途: 负载均衡, 故障恢复, 能耗优化, 边缘计算, serverless;</li>
</ul>
</li>
</ul>
<h3 id="vm-migration-的应用场景">VM Migration 的应用场景</h3>
<ul>
<li><strong>负载均衡</strong>: 迁移 VM 到空闲主机, 避免过载;</li>
<li><strong>故障恢复 &amp; 维护</strong>: 宿主机要重启/打补丁时, 迁移 VM 保证服务不中断;</li>
<li><strong>节能</strong>: 低峰时迁移 VM 到少数主机, 其余关机省电;</li>
<li><strong>靠近用户</strong>: 边缘计算/5G MEC 中, 把 VM 迁移到更靠近用户的节点, 降低延迟;</li>
<li><strong>高可用</strong>: 宿主机预测性故障 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 提前迁移 VM;</li>
<li><strong>Serverless/JIT 服务</strong>: 快速迁移/实例化 VM 以支持函数级弹性;</li>
</ul>
<h2 id="requirements">Requirements</h2>
<p>LightVM 设计目标是满足容器的关键特征:</p>
<h3 id="fast-instantiation-快速实例化">Fast Instantiation(快速实例化)</h3>
<ul>
<li>容器: 100–200ms 内即可运行服务;</li>
<li>传统 VM: 1–2s 启动, 过慢;</li>
<li>LightVM: <strong>2.3ms</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 接近进程级别;</li>
<li>应用: serverless, 按需网络功能, 防火墙;</li>
</ul>
<h3 id="high-instance-density-高密度实例">High Instance Density(高密度实例)</h3>
<ul>
<li>容器: 单机数千以上;</li>
<li>传统 VM: 几十~几百;</li>
<li>LightVM: <strong>数千到上万 VM</strong>, 资源消耗接近容器;</li>
</ul>
<h3 id="pause-unpause-快速挂起-恢复">Pause/Unpause(快速挂起/恢复)</h3>
<ul>
<li>容器: 毫秒级冻结/解冻, 便于资源复用;</li>
<li>VM(传统): 挂起/恢复通常要数百毫秒以上;</li>
<li>LightVM: <strong>30ms 挂起, 25ms 恢复</strong>;</li>
</ul>
<h3 id="small-image-memory-小镜像-小内存">Small Image &amp; Memory(小镜像 &amp; 小内存)</h3>
<ul>
<li>传统 VM 镜像数百 MB~GB, 启动慢;</li>
<li>容器镜像数 MB~几十 MB;</li>
<li>LightVM: <strong>镜像 480KB–数十 MB, 运行时内存 3.6MB</strong>;</li>
<li>工具: <strong>Tinyx</strong> + <strong>unikernel</strong>;</li>
</ul>
<h2 id="lightweight-vms">Lightweight VMs</h2>
<h3 id="背景与动机">背景与动机</h3>
<ul>
<li>第一步优化目标: 减少 VM 的 <strong>镜像大小</strong> 和 <strong>内存占用</strong>;</li>
<li>观察: 大多数容器和 VM 只运行 <strong>单一应用</strong>;
<ul>
<li>如果 VM 仅包含应用所需的最小功能, 可以显著降低内存消耗;</li>
</ul>
</li>
<li>本文探索两条路径:
<ol>
<li><strong>Unikernels</strong>: 应用与极简 OS 链接 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 专用 VM, 体积仅几 MB;</li>
<li><strong>Tinyx</strong>: 自动化工具构建最小化 Linux 发行版 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 几十 MB 镜像, 约 30MB RAM 即可运行;</li>
</ol>
</li>
</ul>
<h3 id="3-1-unikernels">3.1 Unikernels</h3>
<ul>
<li><strong>定义</strong>: 将目标应用与极简 OS(如 MiniOS)直接链接, 生成专用 VM;</li>
<li><strong>特点</strong>:
<ul>
<li>没有用户/内核分离, 没有多进程, 极度精简;</li>
<li>适合运行单一任务应用;</li>
</ul>
</li>
<li><strong>实例</strong>:
<ul>
<li><strong>ClickOS</strong>: 运行 Click modular router 配置;</li>
<li><strong>Mirage</strong>: 将 OCaml 应用打包为 VM;</li>
<li><strong>Mini-OS</strong>: Xen 自带的玩具操作系统, 功能有限, 但可快速构建 unikernel;</li>
</ul>
</li>
<li><strong>示例: Daytime unikernel</strong>
<ul>
<li>基于 Mini-OS + lwIP, 仅需 50 行代码实现返回时间的 TCP 服务器;</li>
<li>镜像大小: <strong>480KB (未压缩)</strong>;</li>
<li>内存占用: <strong>3.6MB</strong>(需要轻微修改 Xen toolstack 绕过 4MB 最小限制);</li>
</ul>
</li>
<li><strong>更多应用</strong>:
<ul>
<li>TLS 终止代理;</li>
<li>Minipython(基于 Micropython 的 unikernel, 用于 AWS Lambda 类似服务);</li>
<li>这些应用镜像约 1MB, 运行内存 ~8MB;</li>
</ul>
</li>
<li><strong>局限</strong>:
<ul>
<li>需要把应用移植到 Mini-OS, 开发成本高;</li>
<li>对依赖 Linux syscall API 的现有应用, 移植困难;</li>
</ul>
</li>
</ul>
<h3 id="3-2-tinyx">3.2 Tinyx</h3>
<ul>
<li><strong>定位</strong>: 在性能与通用性之间的折中:
<ul>
<li>比 unikernel 通用(无需重写应用);</li>
<li>比完整 Linux VM 更轻量;</li>
</ul>
</li>
<li><strong>输入</strong>:
<ol>
<li>应用(例如 nginx);</li>
<li>目标平台(例如 Xen);</li>
</ol>
</li>
<li><strong>输出</strong>:
<ul>
<li>一个最小化的 Linux 发行版 rootfs;</li>
<li>一个优化过的 Linux 内核;</li>
</ul>
</li>
</ul>
<h4 id="文件系统构建">文件系统构建</h4>
<ul>
<li>包含:
<ul>
<li>应用本体</li>
<li>应用依赖</li>
<li>BusyBox(提供基础工具)</li>
</ul>
</li>
<li>依赖解析方法:
<ul>
<li><code>objdump</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 提取应用所需库;</li>
<li>Debian 包管理器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 解析依赖;</li>
</ul>
</li>
<li>优化:
<ul>
<li><strong>黑名单</strong>: 剔除运行时不必要的安装类依赖(如 dpkg);</li>
<li><strong>白名单</strong>: 用户可强制保留某些包;</li>
</ul>
</li>
<li><strong>OverlayFS 构建机制</strong>:
<ol>
<li>在 Debian minimal debootstrap 上挂载一个空 OverlayFS;</li>
<li>在挂载目录中安装依赖(行为与正常 Debian 相同);</li>
<li>卸载 OverlayFS <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> upperdir 保留完整, 已配置好的文件;</li>
<li>删除缓存, dpkg/apt 文件, 多余目录;</li>
<li>将结果叠加在 BusyBox rootfs 下, 形成最终 Tinyx 发行版;</li>
<li>在 BusyBox init 中加入 glue 代码启动应用;</li>
</ol>
</li>
</ul>
<h4 id="内核构建">内核构建</h4>
<ul>
<li>基线配置: <code>tinyconfig</code>;</li>
<li>根据目标平台加入选项(如 Xen/KVM);</li>
<li>默认禁用:
<ul>
<li>内核模块支持;</li>
<li>对虚拟化无用的驱动(如裸机硬件驱动);</li>
</ul>
</li>
<li>可选优化: 逐一禁用用户指定的内核选项 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 重编译 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 启动测试 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 不影响运行则保留禁用;</li>
<li>效果:
<ul>
<li>Tinyx 内核体积比 Debian kernel 小一半;</li>
<li>运行内存占用: <strong>1.6MB (Tinyx) vs 8MB (Debian)</strong>;</li>
</ul>
</li>
</ul>
<h2 id="virtualization-today">Virtualization Today</h2>
<h3 id="背景">背景</h3>
<p>Xen 是一种在生产环境广泛使用的 type-1 hypervisor(如 Amazon EC2);</p>
<ul>
<li>Xen 的 hypervisor 本身仅有约 11.4K LoC, 可信计算基较小, 隔离性强;</li>
<li>对比: KVM 基于 Linux 内核, 可信计算基更大;</li>
<li>本节以 Xen 为研究对象, 分析现有虚拟化技术在轻量 VM 场景下的性能表现;</li>
</ul>
<h3 id="4-1-short-xen-primer">4.1 Short Xen Primer</h3>
<ul>
<li>Xen hypervisor 只负责最基本的资源管理(CPU, 内存等);</li>
<li>Xen 启动后会自动创建 <strong>Dom0</strong>:
<ul>
<li>Dom0 一般运行 Linux, 包含工具栈 (xl, libxl, libxc) 用于 VM 创建/迁移/关闭;</li>
<li>Dom0 还运行 <strong>XenStore</strong>: 一个中心化注册表, 记录 VM 与设备信息, 提供 watch/callback 机制;</li>
<li>Dom0 还托管物理设备驱动, 以及软件交换机(如 Open vSwitch);</li>
</ul>
</li>
<li>Xen 采用 <strong>split driver 模型</strong>:
<ul>
<li><strong>后端驱动 (netback)</strong> 在 Dom0;</li>
<li><strong>前端驱动 (netfront)</strong> 在来宾 VM;</li>
<li>两者通过共享内存和 <strong>event channels(软件中断)</strong> 通信;</li>
</ul>
</li>
</ul>
<h3 id="4-2-overhead-investigation">4.2 Overhead Investigation</h3>
<p>实验环境: Intel Xeon E5-1630 v3 (3.7GHz) + 128GiB DDR4, Xen 与 Linux 版本 4.8;</p>
<h4 id="测试方法">测试方法</h4>
<ul>
<li>顺序启动 1000 个 VM, 测量:
<ul>
<li><strong>创建时间 (create time)</strong>: toolstack 准备 VM 的耗时;</li>
<li><strong>启动时间 (boot time)</strong>: VM 内核启动到可用的耗时;</li>
</ul>
</li>
<li>三类 VM:
<ul>
<li>Debian minimal VM(1.1GB);</li>
<li>Tinyx VM(9.5MB);</li>
<li>Daytime unikernel(480KB);</li>
</ul>
</li>
<li>另外对比: Docker 容器, Linux 进程;</li>
<li>镜像存放在 RAM disk, 避免 I/O 干扰;</li>
</ul>
<h4 id="实验结果">实验结果</h4>
<ul>
<li><strong>Debian VM</strong>: 创建 ~500ms, 启动 ~1.5s;</li>
<li><strong>Tinyx VM</strong>: 创建 ~360ms, 启动 ~180ms;</li>
<li><strong>Unikernel</strong>: 创建 ~80ms, 启动 ~3ms;</li>
<li><strong>Docker 容器</strong>: 启动 ~200ms;</li>
<li><strong>Linux 进程 (fork/exec)</strong>: 启动 ~3.5ms(均值), 90 分位数 ~9ms;</li>
</ul>
<p>随着 VM 数量增加, <strong>创建时间显著上升</strong>:</p>
<ul>
<li>创建第 1000 个 VM: Debian 需 42s, Tinyx 需 10s, Unikernel 需 700ms;</li>
<li>进程/容器的创建时间几乎不随数量增加而变化;</li>
<li>结论: 随着 VM 变得轻量, <strong>VM 实例化 (instantiation) 成为主要瓶颈</strong>;</li>
</ul>
<h4 id="开销分解">开销分解</h4>
<p>通过对 <code>xl</code> 和 <code>libxl</code> 插桩, 发现创建 VM 的开销主要分布在:</p>
<ul>
<li>解析配置文件;</li>
<li>hypervisor 交互(分配内存, 创建 vCPU);</li>
<li>XenStore 写入(例如 VM 名称, 设备信息);</li>
<li>虚拟设备的创建与配置;</li>
<li>内核镜像解析与加载;</li>
<li>工具栈内部状态维护;</li>
</ul>
<p>结果(Figure 5):</p>
<ul>
<li><strong>主要瓶颈</strong>: XenStore 交互 + 虚拟设备创建;</li>
<li>其他部分(解析 config, hypervisor 交互等)可以忽略不计;</li>
</ul>
<h4 id="xenstore-成本原因">XenStore 成本原因</h4>
<ul>
<li>协议开销大: 每次读写都需要多次消息往返和软件中断;</li>
<li>写入 VM 名称时需与所有已有 VM 比较 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> O(n) 成本;</li>
<li>设备初始化需要写多个记录, 并保证事务原子性;随着 VM 增多, 事务冲突频繁, 导致重试;</li>
<li>XenStore 会记录所有访问到 20 个日志文件, 定期 log rotation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 导致性能尖峰;</li>
</ul>
<h2 id="lightvm">LightVM</h2>
<h3 id="目标与总体设计">目标与总体设计</h3>
<ul>
<li>目标: 让 <strong>VM 启动时间接近进程启动时间</strong>(毫秒级), 而不仅是优化现有 Xen 代码路径;</li>
<li>痛点: <strong>XenStore 的集中式, 类文件系统 API 太慢</strong>, VM 创建/启动期间需要几十次软件中断与特权域切换; 与之对比, <code>fork</code> 只需一次用户态<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span>内核态跨越;</li>
<li>方案: <strong>重构 Xen 控制面</strong>, 形成 LightVM 架构(见 Figure 6):
<ul>
<li><strong>noxs</strong>: 取消 VM 创建/启动时对 XenStore 的依赖, 前后端驱动通过共享内存直接交换信息, 减少中断与域切换;</li>
<li><strong>chaos/libchaos</strong>: 精简的工具栈, 替换 <code>xl/libxl</code>;</li>
<li><strong>split toolstack</strong>: 将创建流程拆为 <strong>prepare</strong> 与 <strong>execute</strong> 两阶段, 显著减少&quot;命令触发时&quot;的工作量;</li>
<li><strong>xendevd</strong>: 二进制守护进程, 替换慢速的 bash 热插拔脚本, 快速把虚拟接口加入软件交换机或完成块设备设置;</li>
<li><strong>libxc</strong>: 仍用于保存/恢复/迁移的数据面传输;</li>
</ul>
</li>
</ul>
<h3 id="5-1-noxs-no-xenstore-与-chaos-工具栈">5.1 Noxs(No XenStore)与 Chaos 工具栈</h3>
<ul>
<li>标准 Xen(Figure 7a)中:
<ul>
<li>工具栈向 XenStore 写入&quot;需要网卡&quot;的条目; 后端(netback)监听目录, 分配 <strong>event channel</strong> 与 <strong>grant reference</strong> 并回写到 XenStore; 来宾启动后由前端(netfront)到 XenStore 取回参数完成初始化;</li>
<li>实际创建流程会交互 <strong>30+ 个 XenStore 项目</strong>, VM 数量越多越慢;</li>
</ul>
</li>
<li>核心洞见: <strong>hypervisor 已经掌握大多数必要信息</strong>(如 VM id), 可把其扩展为&quot;集中存储&quot;的实现载体, 规避 XenStore;</li>
<li>LightVM(Figure 7b)做法:
<ul>
<li>用 <strong>libchaos/chaos</strong> 替换 <code>libxl/xl</code>, 彻底移除 <code>libxs</code>/XenStore 依赖;</li>
<li><strong>为每个 VM 分配一页&quot;设备页 (device page)&quot;</strong>: 记录该 VM 的设备信息(block/net 的 backend-id, event channel, grant ref);</li>
<li>新增 <strong>hypercall</strong>: Dom0 可写该页(受控), 来宾以只读方式映射;</li>
<li><strong>创建流程</strong>:
<ol>
<li><code>chaos create</code> 先通过 <strong>noxs 内核模块 ioctl</strong> 向后端请求创建设备, 后端返回通信细节(event channel, grant ref等);</li>
<li>工具栈调用 <strong>hypercall</strong> 将这些细节写入该 VM 的设备页;</li>
<li>来宾启动时通过 <strong>hypercall</strong> 向 hypervisor 要到设备页地址并 <strong>映射到自身地址空间</strong>(Linux 与 Mini-OS 均做了前端修改);</li>
<li>前端用设备页里的信息完成 <strong>grant 映射</strong> 与 <strong>event channel 绑定</strong>, 随后前后端互换状态(如网卡 MAC)并通过事件通道做通知(取代 XenStore watches);</li>
</ol>
</li>
<li><strong>无 XenStore 的迁移</strong>: 新增 <strong>sysctl 伪设备</strong>(front/back + 设备页 + 事件通道)承载电源类操作:
<ul>
<li><code>chaos</code> 与目标机 <strong>迁移守护进程建立 TCP 连接</strong>, 先发送客体配置让对端预创建 domain 与设备;</li>
<li>源端通过对 <strong>sysctlback 发 ioctl</strong> 触发 <strong>suspend</strong>(在共享页打上&quot;suspend&quot;理由并触发事件通道);</li>
<li>来宾 <strong>保存内部状态并解绑 noxs 相关资源</strong>; 随后用 <strong>libxc</strong> 传输来宾数据到远端;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="5-2-split-toolstack-准备-执行分离">5.2 Split Toolstack(准备/执行分离)</h3>
<ul>
<li>观察: 大量创建时执行的代码 <strong>对所有 VM 通用或对一类配置通用</strong>, 没必要在每次&quot;创建命令&quot;时现算;</li>
<li>做法(Figure 8):
<ul>
<li>用 <strong>libchaos</strong> 替换标准工具栈, 并拆为两阶段:
<ul>
<li><strong>Prepare(后台守护进程 chaos daemon 周期执行)</strong>: 预做与 VM 通用的工作(如让 hypervisor 生成 ID, 准备管理信息, 分配 CPU 资源等), 生成一批 <strong>VM shells</strong> 放入池中, 数量可配置, 始终保持可用;</li>
<li><strong>Execute(收到创建命令时)</strong>: <code>chaos</code> 解析配置, 向守护进程要一个匹配需求的 <strong>shell</strong>, 在其上完成剩余的 <strong>VM 专属步骤</strong>(装载内核镜像, 设备收尾初始化), 然后 <strong>boot</strong>;</li>
</ul>
</li>
</ul>
</li>
<li>效果: 将大量与&quot;具体 VM 无关&quot;的慢路径前移, <strong>极大缩短创建命令的关键路径</strong>;</li>
</ul>
<h3 id="5-3-替换热插拔脚本-xendevd">5.3 替换热插拔脚本: xendevd</h3>
<ul>
<li>标准 Xen 中, 虚拟设备创建常需用户态脚本(<code>xl</code> 直接调 bash 或 <code>udevd</code> 触发同样脚本), <strong>单次脚本启动与执行要数十毫秒</strong>, 放大启动时延;</li>
<li>方案: 实现 <strong>xendevd</strong> 二进制守护进程, 直接监听后端的 udev 事件并执行 <strong>预定义的快速设置</strong>, <strong>无需 fork/bash</strong>, 显著减小设备接入软件交换机/块设备准备的时间;</li>
</ul>
<h3 id="组合效果-figure-9">组合效果(Figure 9)</h3>
<ul>
<li>对 daytime unikernel, 1,000 个实例创建时间对比:
<ul>
<li><code>xl</code>(标准 Xen): 最慢;</li>
<li><code>chaos [XS]</code>(仅换工具栈, 仍用 XenStore)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 更快;</li>
<li><code>chaos [XS+split]</code>(再加拆分工具栈)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 继续下降;</li>
<li><code>chaos [NoXS]</code>(去 XenStore)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 明显下降;</li>
<li><strong>LightVM(NoXS + split + xendevd 全开)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 最快, 且随已运行 VM 数量增长更平缓</strong>;</li>
</ul>
</li>
<li>直观结论: <strong>去 XenStore</strong>, <strong>拆分工具栈</strong>, <strong>替换热插拔脚本</strong> 三者叠加, 才能把 VM 创建时延压低到毫秒级并具备良好扩展性;</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Yuchen You (Wesley)</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/23/wesley_knowledge_repo/os/historical/15.vm_lighter_than_container/">http://example.com/2025/09/23/wesley_knowledge_repo/os/historical/15.vm_lighter_than_container/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/operating-system/">operating_system</a><a class="post-meta__tags" href="/tags/virtual-machine/">virtual_machine</a><a class="post-meta__tags" href="/tags/kernel/">kernel</a><a class="post-meta__tags" href="/tags/container/">container</a></div><div class="post_share"><div class="social-share" data-image="/img/me_new.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/25/wesley_knowledge_repo/ds/3.PB-Replication%20&amp;%20Linearizability/" title="3.PB-Replication &amp; Linearizability"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">3.PB-Replication &amp; Linearizability</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/23/wesley_knowledge_repo/os/REST%20API/" title="REST API"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">REST API</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2025/09/21/wesley_knowledge_repo/os/historical/13.x86virt_comp/" title="13.x86virt_comp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-21</div><div class="title">13.x86virt_comp</div></div></a></div><div><a href="/2025/09/22/wesley_knowledge_repo/os/historical/14.turtle_IBM/" title="14.turtle_IBM.md"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="title">14.turtle_IBM.md</div></div></a></div><div><a href="/2025/07/21/wesley_knowledge_repo/os/Xen%20%E4%B8%8E%20KVM%20%E7%9A%84%20hyprvisor%20%E8%AE%B2%E8%A7%A3/" title="Xen 与 KVM 的 hyprvisor 讲解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-21</div><div class="title">Xen 与 KVM 的 hyprvisor 讲解</div></div></a></div><div><a href="/2025/09/06/wesley_knowledge_repo/os/kernel/SYSCALL_DEFINE/" title="SYSCALL_DEFINE"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-06</div><div class="title">SYSCALL_DEFINE</div></div></a></div><div><a href="/2025/09/13/wesley_knowledge_repo/os/historical/5.Plan9_9P/" title="5.Plan9_9P"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="title">5.Plan9_9P</div></div></a></div><div><a href="/2025/09/13/wesley_knowledge_repo/os/historical/7.micro-Kernel/" title="7.micro-Kernel"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="title">7.micro-Kernel</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/me_new.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Yuchen You (Wesley)</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">291</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/1WesleyYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/1Wesleyyou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yuchenxr@umich.edu" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/yuchen-you-a74940314/?locale=en_US" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #4a4dbe;"></i></a><a class="social-icon" href="/Resume.pdf" target="_blank" title="CV"><i class="fas fa-address-card" style="color: #251456;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tinyx-%E4%B8%8E-overlayfs"><span class="toc-number">1.1.</span> <span class="toc-text">Tinyx 与 OverlayFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#noxs-%E4%B8%8E-chaos-toolstack"><span class="toc-number">1.2.</span> <span class="toc-text">Noxs 与 Chaos Toolstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E9%A1%B5%E6%98%A0%E5%B0%84-device-page-mapping"><span class="toc-number">1.3.</span> <span class="toc-text">设备页映射 (Device Page Mapping)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sysctl-%E4%BC%AA%E8%AE%BE%E5%A4%87"><span class="toc-number">1.4.</span> <span class="toc-text">Sysctl 伪设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-connection-%E5%9C%A8%E8%BF%81%E7%A7%BB%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">TCP Connection 在迁移中的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#checkpointing-%E4%B8%8E-migration"><span class="toc-number">1.6.</span> <span class="toc-text">Checkpointing 与 Migration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vm-migration-%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.</span> <span class="toc-text">VM Migration 的应用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requirements"><span class="toc-number">2.</span> <span class="toc-text">Requirements</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fast-instantiation-%E5%BF%AB%E9%80%9F%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text">Fast Instantiation(快速实例化)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#high-instance-density-%E9%AB%98%E5%AF%86%E5%BA%A6%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">High Instance Density(高密度实例)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pause-unpause-%E5%BF%AB%E9%80%9F%E6%8C%82%E8%B5%B7-%E6%81%A2%E5%A4%8D"><span class="toc-number">2.3.</span> <span class="toc-text">Pause&#x2F;Unpause(快速挂起&#x2F;恢复)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#small-image-memory-%E5%B0%8F%E9%95%9C%E5%83%8F-%E5%B0%8F%E5%86%85%E5%AD%98"><span class="toc-number">2.4.</span> <span class="toc-text">Small Image &amp; Memory(小镜像 &amp; 小内存)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lightweight-vms"><span class="toc-number">3.</span> <span class="toc-text">Lightweight VMs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%B8%8E%E5%8A%A8%E6%9C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">背景与动机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-unikernels"><span class="toc-number">3.2.</span> <span class="toc-text">3.1 Unikernels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-tinyx"><span class="toc-number">3.3.</span> <span class="toc-text">3.2 Tinyx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA"><span class="toc-number">3.3.1.</span> <span class="toc-text">文件系统构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%9E%84%E5%BB%BA"><span class="toc-number">3.3.2.</span> <span class="toc-text">内核构建</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virtualization-today"><span class="toc-number">4.</span> <span class="toc-text">Virtualization Today</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">4.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-short-xen-primer"><span class="toc-number">4.2.</span> <span class="toc-text">4.1 Short Xen Primer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-overhead-investigation"><span class="toc-number">4.3.</span> <span class="toc-text">4.2 Overhead Investigation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">4.3.1.</span> <span class="toc-text">测试方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">4.3.2.</span> <span class="toc-text">实验结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E9%94%80%E5%88%86%E8%A7%A3"><span class="toc-number">4.3.3.</span> <span class="toc-text">开销分解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xenstore-%E6%88%90%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-number">4.3.4.</span> <span class="toc-text">XenStore 成本原因</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lightvm"><span class="toc-number">5.</span> <span class="toc-text">LightVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E4%B8%8E%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.</span> <span class="toc-text">目标与总体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-noxs-no-xenstore-%E4%B8%8E-chaos-%E5%B7%A5%E5%85%B7%E6%A0%88"><span class="toc-number">5.2.</span> <span class="toc-text">5.1 Noxs(No XenStore)与 Chaos 工具栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-split-toolstack-%E5%87%86%E5%A4%87-%E6%89%A7%E8%A1%8C%E5%88%86%E7%A6%BB"><span class="toc-number">5.3.</span> <span class="toc-text">5.2 Split Toolstack(准备&#x2F;执行分离)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%9B%BF%E6%8D%A2%E7%83%AD%E6%8F%92%E6%8B%94%E8%84%9A%E6%9C%AC-xendevd"><span class="toc-number">5.4.</span> <span class="toc-text">5.3 替换热插拔脚本: xendevd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%95%88%E6%9E%9C-figure-9"><span class="toc-number">5.5.</span> <span class="toc-text">组合效果(Figure 9)</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/29/wesley_knowledge_repo/os/historical/18.vmware_esx_mem/" title="18.vmware_esx_mem">18.vmware_esx_mem</a><time datetime="2025-09-29T05:19:27.000Z" title="Created 2025-09-29 13:19:27">2025-09-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/28/wesley_knowledge_repo/os/historical/17.superpage/" title="17.superpage">17.superpage</a><time datetime="2025-09-28T08:35:17.000Z" title="Created 2025-09-28 16:35:17">2025-09-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/25/wesley_knowledge_repo/ds/3.PB-Replication%20&amp;%20Linearizability/" title="3.PB-Replication &amp; Linearizability">3.PB-Replication &amp; Linearizability</a><time datetime="2025-09-25T13:20:55.000Z" title="Created 2025-09-25 21:20:55">2025-09-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/23/wesley_knowledge_repo/os/historical/15.vm_lighter_than_container/" title="15.vm_lighter_than_container">15.vm_lighter_than_container</a><time datetime="2025-09-23T11:03:49.000Z" title="Created 2025-09-23 19:03:49">2025-09-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/23/wesley_knowledge_repo/os/REST%20API/" title="REST API">REST API</a><time datetime="2025-09-23T11:03:41.000Z" title="Created 2025-09-23 19:03:41">2025-09-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Yuchen You (Wesley)</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>